# 예약 플로우 & 상태 전이(상세) — 의료업체 통합 예약 모듈 공통(병원/약국/검진센터)

## 0. 문서 목적/적용 범위
- 본 문서는 **의료업체 통합 “예약 추천” 모듈**의 추천 처리 흐름과 상태 전이를 상세 정의한다.
- **병원/약국/검진센터 공통 적용**을 전제로 한다.
- 포함: 추천 **생성/조건 변경(재추천)/추천 종료(저장/삭제)**, 핸드오프(전화/링크 제공), 예외 처리.
- 제외: 의료 진단·처방, 보험/결제, EMR 등 의료 시스템 상세 연동 규격.

---

## 1. 공통 개념 정의

### 1.1 엔티티(개념)
- **Provider(업체)**: 병원/약국/검진센터를 포괄하는 예약 대상 단위
- **ServiceType(방문/업무 유형)**: 진료, 검진, 처방 조제/수령, 상담 등 업체 내 예약 가능한 항목
- **Slot(예약 슬롯)**: 날짜/시간 단위의 예약 가능 구간(가용성 확인 대상)
- **Reservation(예약)**: 사용자와 Provider/Slot/ServiceType의 결합 결과(상태 포함)

### 1.2 예약 식별자
- **reservation_id**: 시스템 내부 식별자(필수)
- 조회 보조키(선택): `phone + date_range`, `name + phone`, `reservation_code` 등(프로젝트 구현 방식에 따라 채택)

---

## 2. 공통 데이터(필수/선택) 정의

### 2.1 필수 정보(공통)
| 항목 | 설명 | 수집 방식(예시) |
|---|---|---|
| Provider 유형 | 병원/약국/검진센터 | 사용자 선택 |
| Provider(업체) | 업체명 또는 지점 | 검색 후 선택 |
| 날짜 | 방문/수령/검진 날짜 | 캘린더/텍스트 |
| 시간 또는 시간대 | 특정 시각 또는 “오전/오후” | 슬롯 선택 |
| 방문자 | 본인/가족(대리) | 선택 |
| 연락처 | 리마인드/확인용 | 입력 |

### 2.2 선택 정보(공통)
| 항목 | 설명 |
|---|---|
| ServiceType | 방문 목적/업무 유형(진료/검진/수령 등) |
| 방문 목적 메모 | 사용자의 추가 요청(예: “주차 안내 필요”) |
| 증상 요약 | “방문 유형 추천”을 위한 요약(의료 판단 금지, 장기 관리 저장은 타 모듈 범위) |
| 알림 수신 채널 | 앱푸시/문자/카카오 등(지원 채널에 따라) |

---

## 3. 상태(State) 정의(공통)

### 3.1 상태 목록(권장 최소)
| 상태 | 의미 | 진입 조건(예시) | 종료 조건(예시) |
|---|---|---|---|
| `DRAFT` | 추천 조건 수집 중 | 추천 시작 | 추천 제시 또는 중단 |
| `RECOMMENDED` | 추천 결과 제시됨 | 후보 리스트 생성 | 조건 변경/저장/핸드오프/종료 |
| `SAVED` | 추천 결과 저장됨(선택) | 사용자가 저장 선택 | 재확인/삭제/만료 |
| `HANDOFF` | 외부 예약으로 연결(전화/링크 제공) | 사용자가 후보 선택 | 종료 또는 재추천 |
| `FAILED` | 추천 실패(데이터 부족/연동 실패) | 소스 조회 실패/검증 실패 | 재시도/대안 제시/종료 |
| `EXPIRED` | 추천 만료 | 저장기간/TTL 만료 | 재진입(새 DRAFT) |

> 메모: 구현 단순화를 위해 `CHANGE_REQUESTED`, `CANCEL_REQUESTED`는 내부 처리 상태로만 사용하고, UI/대화에서는 “변경 중/취소 중”으로 표기한다.

---

## 4. 이벤트(Event) 정의(공통)

| 이벤트 | 설명 |
|---|---|
| `EVT_START_RECOMMEND` | 추천 시작 |
| `EVT_COLLECT_FIELD` | 필드 수집(지역/시간대/업체유형/방문목적 등) |
| `EVT_VALIDATE_OK / EVT_VALIDATE_FAIL` | 필수값/정책 검증 통과/실패 |
| `EVT_USER_CONFIRM` | 사용자 선택/확정(후보 선택 등) |
| `EVT_USER_EDIT` | 사용자 수정 요청 |
| `EVT_USER_ABORT` | 사용자 중단(그만할래요) |
| `EVT_SOURCE_FAIL` | 소스 조회 실패/타임아웃 |
| `EVT_RECOMMEND_SUCCESS / EVT_RECOMMEND_FAIL` | 추천 생성 성공/실패 |
| `EVT_SAVE` | 추천 저장 |
| `EVT_DELETE` | 저장된 추천 삭제 |
| `EVT_HANDOFF` | 전화/링크 제공(외부 예약으로 연결) |
| `EVT_TTL_EXPIRED` | 만료(작성/홀드 시간 초과) |

---

## 5. 상태 전이 다이어그램(텍스트)

### 5.1 추천 생성(Recommend) — 상태 전이
```
[START]
  |
  | EVT_START_RECOMMEND
  v
DRAFT
  |  (EVT_COLLECT_FIELD 반복: providerType/region/timeWindow/purpose/preferences ...)
  |---- EVT_TTL_EXPIRED -----------------------------> EXPIRED
  |
  | EVT_VALIDATE_OK
  v
RECOMMENDED  <---- EVT_RECOMMEND_FAIL / EVT_SOURCE_FAIL -----
  |                                                   |
  | EVT_USER_EDIT (조건 변경)                          | (리커버리) 조건 완화/대안 제시
  v                                                   |
DRAFT  -----------------------------------------------|
  |
  | EVT_HANDOFF (후보 선택)
  v
HANDOFF
  |
  | EVT_SAVE (선택)
  v
SAVED  ---- EVT_DELETE -------------------------------> EXPIRED
```

---

## 6. 추천 플로우(업무/대화) 상세

### 6.1 추천 생성 플로우(공통)
1) **의도 확인**
   - “예약을 대신 진행하기보다는, 조건에 맞는 기관과 연락 경로를 추천해드릴까요?”
2) **업체 유형 및 업체 선택**
   - 병원/약국/검진센터 → 지역/업체명 → 후보 리스트 제시 → 선택
3) **ServiceType(방문/업무 유형) 결정**
   - 사용자 직접 입력 또는 “증상 기반 방문 유형 추천(AI)” 결과를 선택지로 제공
4) **조건 수집**
   - 날짜/시간대(선호), 거리/이동수단(선택), 우선순위(가까움/평점/야간 등)
5) **추천 결과 제시(`RECOMMENDED`)**
   - 후보 3~5개 + 연락/경로 + 준비사항(가능 시) 요약
6) **핸드오프(`HANDOFF`)**
   - 선택 후보에 대해 전화/홈페이지/지도 링크 제공(외부 예약 연결)

### 6.2 추천 조건 변경(재추천) 플로우(공통)
1) **변경 의도 확인**
   - “지역/거리/시간대/업체 유형 중 무엇을 바꿀까요?”
2) **조건 업데이트**
   - 변경된 조건만 반영
3) **재추천**
   - 후보 재생성 → `RECOMMENDED`로 복귀

### 6.3 추천 종료/삭제 플로우(공통)
1) **종료 의도 확인**
   - “추천을 종료할까요? 저장해둘까요?”
2) **저장/삭제**
   - 저장(`SAVED`) 또는 삭제/만료(`EXPIRED`)

### 6.4 “완료”의 정의(추천 중심)
- 본 모듈의 완료는 “예약 확정/방문 완료”가 아니라, **핸드오프 제공 완료** 또는 **추천 저장 완료**로 정의한다.

---

## 7. 예외 케이스(5가지 이상) 및 처리 원칙

### 7.1 예외 케이스 목록(최소 8개)
| No | 예외 케이스 | 탐지 지점 | 기대 동작(원칙) | 상태 영향 |
|---:|---|---|---|---|
| 1 | **슬롯 마감/중복 예약** | 확정/변경 직전 가용성 확인 | “선택한 시간이 마감” 안내 → 대안 슬롯 3개 제시 | `PENDING_CONFIRM`→`FAILED` 또는 `DRAFT`로 재수집 |
| 2 | **업체 검색 결과 0건** | 업체 검색 | 범위 확장 질문(지역 재확인/키워드 변경) + “인기 업체” 제안 | `DRAFT` 유지 |
| 3 | **업체 검색 결과 과다(모호)** | 업체 검색 | 필터 질문(지점/진료과/거리) 후 재목록 | `DRAFT` 유지 |
| 4 | **정책 위반(취소/변경 가능 시간 초과)** | 취소/변경 정책 검증 | 정책 안내 + 가능한 대안(전화 문의/다음 예약 생성) | `CANCEL_REQUESTED`/`CHANGE_REQUESTED`→`CONFIRMED`로 원복 |
| 5 | **연락처 형식 오류/불완전** | 필수 정보 수집 | 예시 제시 후 재입력 요구, 2회 실패 시 다른 인증/연락 수단 제안(가능 시) | `DRAFT` 유지 |
| 6 | **예약 식별 실패(예약번호 없음/조회 불가)** | 변경/취소 시작 | 조회 키 재요청(연락처+날짜 등) → 그래도 실패 시 신규 예약 유도 | `CHANGE_REQUESTED`/`CANCEL_REQUESTED`→`FAILED` |
| 7 | **외부 연동 실패/타임아웃** | 확정/변경/취소 처리 | 재시도(1~2회) 후 실패 안내, “임시 접수” 또는 “나중에 다시” 선택 제공 | `FAILED` |
| 8 | **사용자 응답 모호(선택지 미응답)** | 선택 단계 전반 | 번호 선택 형태로 재질문, 중요한 항목부터 1개씩 물어보기 | `DRAFT` 유지 |

### 7.2 예외 처리 공통 원칙
- **사용자 책임 전가 금지**: “다시 해보세요” 대신 가능한 대안(슬롯/업체/채널)을 제시한다.
- **필수 정보는 최소 질문으로 수집**: 누락된 필드만 재질문한다.
- **확정/변경/취소는 반드시 컨펌**: `PENDING_CONFIRM`을 거치고 로그에 남길 수 있게 한다.
- **실패는 복구 경로 제공**: `FAILED` 진입 시 (재시도/대안 제시/종료) 중 선택지를 제공한다.

---

## 8. 구현/통합 시 고려사항(설계 메모)
- 병원/약국/검진센터 간 차이는 **ServiceType**과 **필수 필드 정책**에서 흡수한다.
  - 예: 약국은 “처방전 유무/수령 방식” 같은 추가 필드를 옵션 정책으로 붙일 수 있음
- 상태 머신은 공통으로 유지하고, 업체별 정책은 `validate()` 계층에서 분기한다.
- 통합 챗봇 라우팅 관점에서는 “예약 관련 의도”만 본 모듈로 라우팅하고, 영양·알러지 관리/걸음 수 등은 타 모듈로 라우팅한다.


